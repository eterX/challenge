<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<script src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.3/svg.min.js"></script>
<script>
  function report_err(msg){
    console.log(arguments);
  }
  function parseScript(str){
    var cmd_lines_raw =str.split('\n');
    var cmds = [];
    for ( var i in cmd_lines_raw) {
      cmds[i] = parseLine(cmd_lines_raw[i]);
    }
    return cmds;
  }
  function parseLine(cmd_lines_raw){
    var r = /^(\S+?)\(([\S ]+)+\);?$/g;
    var result = r.exec(cmd_lines_raw);
    var cmd ={method:'',args:[]}
    if(result){
        cmd.method = result[1];
        cmd.args = result[2].replace(/[\'\"]/g,"").split('\,');
    } else {
      cmd.method = 'err';
      cmd.args = 'unparsable line: '+(''+cmd_lines_raw);
      console.log('unparsable line: '+(''+cmd_lines_raw));
    }
    return cmd;
  }

  function trail_points_fn(arg1,arg2){
    console.log('do trail_points',[arg1,arg2]);
    var id=Number(arg1);
    //var trail=trail_template.clone().show();
    trail.attr({points:arg2});
  }


  function cursor_move_fn(arg1,arg2,arg3,arg4){
    console.log('do cursor_move',[arg1,arg2,arg3,arg4]);
    var x=Number(arg2);
    var y=Number(arg3);
    cursor.transform({x:x,y:y});
  }

  var opCodes = {
    err:report_err,
    cursor_move:cursor_move_fn,
    trail_points:trail_points_fn,
    cursor_rotate: function (arg1,arg2){
      console.log('do cursor_rotate',[arg1,arg2])
    }
  }
  var fn_context = window;
  function runBitCode(lines){
    for(var i in lines){
      var line = lines[i];
      var fn = opCodes[line.method];
      if(!fn){
        report_err('fn not recognized',line.method,'line '+(1+1*i));
        return;
      }

      fn.apply(fn_context,line.args)
    }
  }


  //moved to cursor_test()
//  var code  = 'cursor_move(7,500,600,false);';
//      code += '\ncursor_rotate(2,-90);';
//  var code_bitcode = parseScript(code);
//  runBitCode(code_bitcode);


</script>
<script>
  // Connecting to ROS
  // -----------------
  /*
  var ros = new ROSLIB.Ros({
    url : 'ws://manuela:9090'
  });

  // If there is an error on the backend, an 'error' emit will be emitted.
  ros.on('error', function(error) {
    document.getElementById('connecting').style.display = 'none';
    document.getElementById('connected').style.display = 'none';
    document.getElementById('closed').style.display = 'none';
    document.getElementById('error').style.display = 'inline';
    console.log(error);
  });

  // Find out exactly when we made a connection.
  ros.on('connection', function() {
    console.log('Connection made!');
    document.getElementById('connecting').style.display = 'none';
    document.getElementById('error').style.display = 'none';
    document.getElementById('closed').style.display = 'none';
    document.getElementById('connected').style.display = 'inline';
  });

  ros.on('close', function() {
    console.log('Connection closed.');
    document.getElementById('connecting').style.display = 'none';
    document.getElementById('connected').style.display = 'none';
    document.getElementById('closed').style.display = 'inline';
  });

  var listener = new ROSLIB.Topic({
      ros : ros,
      name : '/ged/listener',
      messageType : 'std_msgs/String'
    });

  var listenerCounter = 0

  listenerCounterReset = function () {
      listenerCounter = 0;
  };

  listener.subscribe(function(message) {
        miStr = 'Received message #'+listenerCounter+' on ' + listener.name + ': ' + message.data
        console.log(miStr);
        rect2.attr({ fill: '#0f0'});
        //cambiar texto en miLabel
        //var miLabel = SVG.get('miLabel'); no hace falta, mismo namespace...
        miLabel.text('Received message #'+listenerCounter+' on ' + listener.name + ': ' + message.data);
        miLabel.attr({ fill: '#0f0'});
        listenerCounter +=1;
        });
    //listener.unsubscribe();

*/
</script>
</head>

<body>
  <h1>Client Mockup</h1>
  <div id="statusIndicator">
    <p id="connecting">
      Connecting to rosbridge...
    </p>
    <p id="connected" style="color:#00D600; display:none">
      Connected
    </p>
    <p id="error" style="color:#FF0000; display:none">
      Error in the backend!
    </p>
    <p id="closed" style="display:none">
      Connection closed.
    </p>
      <p id="listenerCounter" style="display:none"></p>

  </div>
  <button type='button' onclick='listenerCounterReset();'>call listenerCounterReset()</button>

  <div id="tsim"></div>
  <script>
    var draw = SVG('tsim').size(1000, 1000);
//    console.log("estoy andando...");
    var rect = draw.rect(1000, 1000).attr({ id: 'map' });

    //TODO: css
    var styleline={stroke:"#dd7052","stroke-width":2,"stroke-dasharray":"9,1.5"}
    var stylemap=styleline;
    stylemap.fill="#aeffff";
    var styletrail={fill:"none","fill-rule":"evenodd",stroke:"#007272","stroke-width":2,"stroke-linecap":"butt","stroke-linejoin":"miter","stroke-opacity":1,"stroke-miterlimit":4,"stroke-dasharray":"2,12","stroke-dashoffset":0}
    //{fill:"#aeffff","fill-opacity":1,stroke:"#dd7052",stroke_width:15,stroke_linejoin:"round",stroke_miterlimit:4,stroke_dasharray:"55,5",}


    //canvas
    var map = SVG.get('map'); //    prueba de referencia
    map.attr(stylemap);

    //cursor
    var cursor_template = draw.group();
    var circle = draw.circle().attr(styleline).attr({id:"cursor_c",cx:0,cy:0,r:25,fill:"#007272","fill-opacity":0.15});
    var line = draw.line("0,0 25,0").attr(styleline).attr({id:"cursor_l"});
    cursor_template.add(circle).add(line).hide();
    cursor_template.hide();

    //marker
    var markers = draw.group();
    var marker_template = draw.group();
    marker_template.add(draw.line("-5,-5 5,5").attr(styleline)).add(draw.line("-5,5 5,-5").attr(styleline));
    marker_template.hide();

    //trail
    var trail_template = draw.polyline().fill('none').attr(styletrail);
    trail_template.hide();




    //TODO: MC: crear una colección de 10 cursores
    var cursor = cursor_template.clone().show(); //x10
    cursor.transform({x:500,y:500});
    //TODO: MC: referenciables globalmente. ejemplo: cursors[2].show()


    //TODO: MC: crear una colección de 10 estelas. referenciable globalmente
    var trail = trail_template.clone().show(); //x10


    cursor_test = function () {
        cursor.transform({x:50,y:50});
        cursor.rotate(45);
        //cursor.animate().translate(50,50); //changes coordinate system...
        //cursor.transform({transformedx:50,transformedy:50});
        //cursor.animate().center(100,50);
        //cursor.animate().move(200,100);

        //testing absolute coordinates... OK!!
        cursor.transform({x:50,y:50}); //testing absolute coordinates... OK!!
        cursor.rotate(45); //testing absolute coordinates... OK!!
        //is cursor in the right place?
        var marker = marker_template.clone().show();
        marker.move(50,75);
        markers.add(marker)
        var marker = marker_template.clone().show();
        marker.move(75,50);
        markers.add(marker)
        // agregar var  marker a un array dentro de un grupo para manipular todos...
        //markers.add(marker_template.clone().move(50,50).show());
        //markers.add(marker_template.clone().move(50,75).show());
        //markers.add(marker_template.clone().move(70,50).show());
      //markers.hide()
        var cursor2 = cursor_template.clone().show();
        cursor2.transform({x:200,y:200});

        var trail = trail_template.clone().show();
        trail.attr({points:"0,0 30,230 100,200 200,200"});

        var miLabel = draw.text(text="{placeholder}").attr({ id: 'miLabel' });

        //test case1 form MC
        var code  = 'cursor_move(7,500.123456,60,false);';
            code += '\ncursor_rotate(2,-90);';
            code += "\ntrail_points(1,'0 0 100 100 200 0 300 100');";
        var code_bitcode = parseScript(code);
        runBitCode(code_bitcode);

        };


    //TODO: MC: implementar
    cursor_move = function (id,x,y,show) {
      /* param: INT id // id del cursor afectado
      param: FLOAT x // posición de destino
      param: FLOAT y // posición de destino
      param: BOOL show // mostrar?
      result: STRING "OK|ERROR"

    ejemplos:        |String recibido desde backend | Acción | Resultado |


        String recibido desde backend: "cursor_move(1, 10.54, -2,3, true)"
        Acciones Javascript:
                cursors_collection[id].transform({x:10.45,y:-2.3});
                show ? cursors_collection[id].show() : cursors_collection[id].hide()
       */
    };

    //TODO: MC: implementar
    cursor_rotate = function (id,theta) {
      /* param: INT id // id del cursor afectado
      param: INTEGER theta // orientación de destino , pasa com está
      result: STRING "OK|ERROR"

    ejemplos:        |String recibido desde backend | Acción | Resultado |

        String recibido desde backend: "cursor_rotate(1, -45)"
        Acciones Javascript:
                 cursors_collection[id].rotate(-45);
       */
    }

    //TODO: MC: implementar
    //trail_points = function (id,points) {
      /* param: INT id // id del trail afectado
      param: STRING points // ej: "", ej; "0,0, 30,30 -20,30"
      result: STRING "OK|ERROR"

      manda este string al atributo points. Principal uso: pints="" para borrar la estela con ""

    ejemplos:        |String recibido desde backend | Acción | Resultado |

        String recibido desde backend: "trail_clear(1,"")"
        Acciones Javascript:
                 if (id  >= 0) { trails_collection[id].attr({points: ""})

        String recibido desde backend: "trail_clear(1,"0,0, 30,30 -20,30")"
        Acciones Javascript:
                 if (id >= 0) { trails_collection[id].attr({points: "0,0, 30,30 -20,30"})



       */
    //}

    //TODO: MC: caso de prueba (Strings recibidos desde backend)
    'cursor_move(1,500,500,true);'
    'cursor_rotate(1,0);'
    'trail_points(1,"");' //tortuga en en centro, sin estela
    'cursor_move(1,550,550,true);'
    'cursor_rotate(1,45);'
    'trail_points(1,"500,500 550,550");'
    'cursor_move(1,500,600,true);'
    'cursor_rotate(1,135);'
    'trail_points(1,"500,500 550,550 500,600");' //tortuga dibujó signo  ">"


    //TODO: MC:  caso2 de prueba (Strings recibidos desde backend)
    'cursor_move(7,500,600,false);'
    'cursor_rotate(2,-90);'
    'cursor_move(7,500,500,true);'
    'trail_points(2,"500,500 500,600");' // otra tortuga cerró el triangulo "|>"



    cursor_test(); // ejemplo de como estaría usando al SVg para representar a cursors y estelas



//            .font({size: 12,anchor: 'end',fill: '#fff'}).move(10, 10)
  </script>


</body>
</html>
